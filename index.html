<!-- https://skefflock.github.io/index.html -->
<!-- https://milligram.io/getting-started.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>onRecord</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="./api_deps.js"></script>
    <script src="./api.js"></script>
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css">
    <style>
      body {
        font-size: 1.3rem;
        line-height: 1.0;
      }
      td, th {
        padding-top: 0.3rem !important;
        padding-bottom: 0.3rem !important;
      }
    </style>
  </head>
  <body>
    <table class="pure-table-horizontal">
      <thead>
        <tr>
            <th>Параметр</th>
            <th>Код</th>
            <th>Значение</th>
        </tr>
      </thead>
        <tr>
          <td>Сотрудник</td>
          <td id="employee_id">-</td>
          <td id="employee_name">-</td>
        </tr>
        <tr>
          <td>Проект</td>
          <td id="project_id">-</td>
          <td id="project_name">-</td>
        </tr>
        <tr>
          <td>Работа</td>
          <td id="work_id">-</td>
          <td id="work_name">-</td>
        </tr>
        <tr>
          <td>Выплаты в пользу сотрудника всего</td>
          <td id="payment_total">-</td>
          <td id="payroll_total">-</td>
        </tr>
        <tr>
          <td>По незакрытым работам</td>
          <td id="payment_active">-</td>
          <td id="payroll_active">-</td>
        </tr>
        <tr>
          <td>По текущему проекту</td>
          <td id="payment_project">-</td>
          <td id="payroll_project">-</td>
        </tr>
        <tr>
          <td>По текущей работе</td>
          <td id="payment_work">-</td>
          <td id="payroll_work">-</td>
        </tr>
      <tbody>
        
      </tbody>
    </table>

    
    <script>
      grist.ready();

      // получение всей таблицы по названию
      async function getTableById(tableId) {
        const result = await grist.docApi.fetchTable(tableId);
        return result; 
      }

      // Используемые таблицы:
      // - Work_hour
      // - Works
      // - Employee
      // - Project
      // - AccountDetail
    
      // на изменение выделения привязанной таблицы
      grist.onRecord(function(record) {

        // активная запись
        console.log(record)
        
        if (!record) {
          document.getElementById('employee_id').innerHTML = "";
          document.getElementById('project_id').innerHTML = "";
          document.getElementById('work_id').innerHTML = "";
          document.getElementById('employee_name').innerHTML = "";
          document.getElementById('project_name').innerHTML = "";
          document.getElementById('work_name').innerHTML = "";
          document.getElementById('payment_total').innerHTML = "";
          document.getElementById('payroll_total').innerHTML = "";
          document.getElementById('payment_active').innerHTML = "";
          document.getElementById('payroll_active').innerHTML = "";
          document.getElementById('payment_project').innerHTML = "";
          document.getElementById('payroll_project').innerHTML = "";
          document.getElementById('payment_work').innerHTML = "";
          document.getElementById('payroll_work').innerHTML = "";
        }

        else {

          // получение таблицы work_hours
          const tableWorkHour = getTableById("Work_hours");

          // вывод промежуточных данных в консоль
          console.log("-- Вывод содержимого таблицы -----");
          console.log(tableWorkHour);
          console.log("-- Конец вывода ------------------");

          // вывод данных в таблицу из выбранной записи
          document.getElementById('employee_name').innerHTML = record.employee_id;
          document.getElementById('project_name').innerHTML = record.project_id;
          document.getElementById('work_id').innerHTML = record.id;
          document.getElementById('work_name').innerHTML = record.work_id;

          // поиск и выбор данных в таблицу из базы данных
          let tableWorkHourRow = tableWorkHour.id.findIndex(record.id);
          let employee_id = tableWorkHour.employee_id[tableWorkHourRow];
          let work_id = tableWorkHour.work_id[tableWorkHourRow];
          let project_id = tableWorkHour.project_id[tableWorkHourRow];

          // фильтрация таблицы рабочих часов только по сотуднику в текущей записи
          let tableWorkHourFiltered = tableWorkHour.filter((row) => row.employee_id = employee_id);

          let payroll_total = 0;
          let payroll_project = 0;
          let payroll_work = 0;

          tableWorkHourFiltered.forEach(row => {
            let currentRowSum = row.pph ? row.pph * row.hours : row.ppd;
            payroll_total += currentRowSum;
            payroll_project += (row.projet_id == project_id ? currentRowSum : 0);
            payroll_work += (row.work_id == work_id ? currentRowSum : 0);
          });

          document.getElementById('employee_id').innerHTML = employee_id;
          document.getElementById('project_id').innerHTML = project_id;
          document.getElementById('payroll_total').innerHTML = payroll_total;
          document.getElementById('payroll_project').innerHTML = payroll_project;
          document.getElementById('payroll_work').innerHTML = payroll_work;


          
        }
      
      });

    </script>

    <p> Версия виджета 0.0.015 </p>
    
  </body>
</html>
